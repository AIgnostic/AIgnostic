# First stage: build
FROM python:3.12 AS builder

# Set the working directory in the container
WORKDIR /app

# Metadata
LABEL org.opencontainers.image.source="https://github.com/AIgnostic/AIgnostic"

# Install Node and pipx & poetry
RUN apt-get update && apt-get install -y --no-install-suggests --no-install-recommends curl
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
RUN apt-get install -y --no-install-suggests --no-install-recommends nodejs pipx
RUN pipx ensurepath
RUN pipx install poetry

ENV PATH="/root/.local/bin:${PATH}"
# Copy the application monorepo to the container
COPY ./package.json /app
COPY ./package-lock.json /app

# Run npm ci
RUN npm ci

COPY ./nx.json /app
# Have to copy thee manually - means we can change code without rebuilding it all as deps didn't change
COPY ./packages/aggregator/pyproject.toml /app/packages/aggregator/pyproject.toml
COPY ./packages/aggregator/poetry.toml /app/packages/aggregator/poetry.toml
COPY ./packages/aggregator/poetry.lock /app/packages/aggregator/poetry.lock
COPY ./packages/aggregator/aggregator/__init__.py /app/packages/aggregator/aggregator/__init__.py
COPY ./packages/aggregator/README.md /app/packages/aggregator/README.md

COPY ./packages/api/pyproject.toml /app/packages/api/pyproject.toml
COPY ./packages/api/poetry.toml /app/packages/api/poetry.toml
COPY ./packages/api/poetry.lock /app/packages/api/poetry.lock
COPY ./packages/api/api/__init__.py /app/packages/api/api/__init__.py 
COPY ./packages/api/README.md /app/packages/api/README.md

COPY ./packages/common/pyproject.toml /app/packages/common/pyproject.toml   
COPY ./packages/common/poetry.toml /app/packages/common/poetry.toml
COPY ./packages/common/poetry.lock /app/packages/common/poetry.lock
COPY ./packages/common/common/__init__.py /app/packages/common/common/__init__.py
COPY ./packages/common/README.md /app/packages/common/README.md

COPY ./packages/llm-insights/pyproject.toml /app/packages/llm-insights/pyproject.toml
COPY ./packages/llm-insights/poetry.toml /app/packages/llm-insights/poetry.toml
COPY ./packages/llm-insights/poetry.lock /app/packages/llm-install/poetry.lock
COPY ./packages/llm-insights/llm_insights/__init__.py /app/packages/llm-insights/llm_insights/__init__.py
COPY ./packages/llm-insights/README.md /app/packages/llm-insights/README.md

COPY ./packages/metrics/pyproject.toml /app/packages/metrics/pyproject.toml
COPY ./packages/metrics/poetry.toml /app/packages/metrics/poetry.toml
COPY ./packages/metrics/poetry.lock /app/packages/metrics/poetry.lock
COPY ./packages/metrics/metrics/__init__.py /app/packages/metrics/metrics/__init__.py
COPY ./packages/metrics/README.md /app/packages/metrics/README.md

COPY ./packages/mocks/pyproject.toml /app/packages/mocks/pyproject.toml
COPY ./packages/mocks/poetry.toml /app/packages/mocks/poetry.toml
COPY ./packages/mocks/poetry.lock /app/packages/mocks/poetry.lock
COPY ./packages/mocks/mocks/__init__.py /app/packages/mocks/mocks/__init__.py
COPY ./packages/mocks/README.md /app/packages/mocks/README.md

COPY ./packages/report-generation/pyproject.toml /app/packages/report-generation/pyproject.toml
COPY ./packages/report-generation/poetry.toml /app/packages/report-generation/poetry.toml
COPY ./packages/report-generation/poetry.lock /app/packages/report-generation/poetry.lock
COPY ./packages/report-generation/report_generation/__init__.py /app/packages/report-generation/report_generation/__init__.py
COPY ./packages/report-generation/README.md /app/packages/report-generation/README.md

COPY ./packages/worker/pyproject.toml /app/packages/worker/pyproject.toml
COPY ./packages/worker/poetry.toml /app/packages/worker/poetry.toml
COPY ./packages/worker/poetry.lock /app/packages/worker/poetry.lock
COPY ./packages/worker/worker/__init__.py /app/packages/worker/worker/__init__.py
COPY ./packages/worker/README.md /app/packages/worker/README.md

COPY ./packages/dispatcher/pyproject.toml /app/packages/dispatcher/pyproject.toml
COPY ./packages/dispatcher/poetry.toml /app/packages/dispatcher/poetry.toml
COPY ./packages/dispatcher/poetry.lock /app/packages/dispatcher/poetry.lock
COPY ./packages/dispatcher/dispatcher/__init__.py /app/packages/dispatcher/dispatcher/__init__.py
COPY ./packages/dispatcher/README.md /app/packages/dispatcher/README.md

COPY ./poetry.lock /app
COPY ./poetry.toml /app
COPY ./pyproject.toml /app

RUN ls -la ./packages/common

# Run poetry install at root
RUN poetry install -v --only=main

# Copy source
COPY ./packages /app/packages

# Copy venv & application code to new image
# Second stage: runtime
FROM python:3.12-slim AS python-prod-base

# Set the working directory in the container
WORKDIR /app

# Create a non-root user and switch to it
RUN useradd -m appuser

# Copy only the necessary files from the builder stage
COPY --from=builder --chown=appuser:appuser /app/packages /app/packages
COPY --from=builder --chown=appuser:appuser /app/.venv /app/.venv

# # Change ownership
# RUN chown -R appuser /app

# Switch
USER appuser

# SO that we can use one image to build each python package,
# we specify them all here as different stages with their appropriat start commands
# then build each image using --target.
# E.g.
# docker build --target api -t aignostic/api:latest -f ./dockerfiles/Dockerfile.python .
# docker build --target worker -t aignostic/worker:latest -f ./dockerfiles/Dockerfile.python .

# Metadata
LABEL org.opencontainers.image.source="https://github.com/AIgnostic/AIgnostic"

FROM python-prod-base AS api
WORKDIR /app/packages/api
CMD ["/app/.venv/bin/python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

FROM python-prod-base AS aggregator
WORKDIR /app/packages/aggregator
CMD ["/app/.venv/bin/python", "-m", "aggregator.aggregator"]

FROM python-prod-base AS worker
WORKDIR /app/packages/worker
CMD ["/app/.venv/bin/python", "-m", "worker.worker"]


# Mocks has an extra build command
FROM builder AS mocks-build
# Some extra files are needed to make nx behave
COPY ./eslint.config.cjs /app
COPY ./jest.config.ts /app
COPY ./jest.preset.js /app
# Run install
RUN poetry run npx nx install mocks --args="--only=main,dev"

# Now build mocks production -> copy paste of code above with mocks builder instead
# Copy venv & application code to new image
# Second stage: runtime
FROM mocks-build AS mocks

# Set the working directory in the container
WORKDIR /app

# Create a non-root user and switch to it
RUN useradd -m appuser

# Copy only the necessary files from the builder stage
COPY --from=builder --chown=appuser:appuser /app/packages /app/packages
COPY --from=builder --chown=appuser:appuser /app/.venv /app/.venv

# Switch
USER appuser

# Unzip financial data
RUN cd /app/packages/mocks/mocks/dataset && unzip -o FinancialPhraseBank-v1.0.zip

# Metadata
LABEL org.opencontainers.image.source="https://github.com/AIgnostic/AIgnostic"


######## SEPARATE: Nginx
FROM nginx:latest AS nginx_reverse_proxy
COPY ./swarm/nginx/prod.nginx.conf /etc/nginx/conf.d/prod.conf
# Done!

